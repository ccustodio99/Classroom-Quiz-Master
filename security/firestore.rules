rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isTeacher() {
      return request.auth != null &&
        request.auth.token.firebase != null &&
        request.auth.token.firebase.sign_in_provider != 'anonymous';
    }

    function isStudent() {
      return request.auth != null &&
        request.auth.token.firebase != null &&
        request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    function teacherOwnsQuiz(quizId) {
      return isTeacher() &&
        quizId != null &&
        exists(/databases/$(database)/documents/quizzes/$(quizId)) &&
        get(/databases/$(database)/documents/quizzes/$(quizId)).data.teacherId == request.auth.uid;
    }

    function sessionOwnedByTeacher(sessionId) {
      return isTeacher() &&
        exists(/databases/$(database)/documents/sessions/$(sessionId)) &&
        get(/databases/$(database)/documents/sessions/$(sessionId)).data.teacherId == request.auth.uid;
    }

    function lowerStatus(value) {
      return (value is string) ? value.lower() : '';
    }

    function sessionJoinable(sessionId) {
      let path = /databases/$(database)/documents/sessions/$(sessionId);
      return exists(path) &&
        (lowerStatus(get(path).data.status) in ['lobby', 'active']) &&
        !(
          (get(path).data.lockAfterQ1 == true) &&
          ((get(path).data.currentIndex == null ? 0 : get(path).data.currentIndex) >= 1)
        );
    }

    function cleanAttemptPayload() {
      return request.resource != null &&
        !request.resource.data.keys().hasAny([
          'points',
          'correct',
          'late',
          'syncedAt',
          'sequenceNumber',
          'scoredAt'
        ]);
    }

    function cleanParticipantPayload() {
      return request.resource != null &&
        !request.resource.data.keys().hasAny(['totalPoints', 'totalTimeMs', 'joinedAt']);
    }

    function assignmentOwnedByTeacher(assignmentId) {
      let path = /databases/$(database)/documents/assignments/$(assignmentId);
      return exists(path) && teacherOwnsQuiz(get(path).data.quizId);
    }

    match /quizzes/{quizId} {
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      allow read, update, delete: if isTeacher() && resource.data.teacherId == request.auth.uid;
    }

    match /sessions/{sessionId} {
      allow read: if sessionOwnedByTeacher(sessionId) || (isStudent() && sessionJoinable(sessionId));
      allow create: if isTeacher() &&
        request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if sessionOwnedByTeacher(sessionId);

      match /participants/{participantId} {
        allow read: if sessionOwnedByTeacher(sessionId) ||
          (isStudent() && sessionJoinable(sessionId) && request.auth.uid == participantId);
        allow create: if
          sessionOwnedByTeacher(sessionId) ||
          (
            isStudent() &&
            sessionJoinable(sessionId) &&
            request.auth.uid == participantId &&
            cleanParticipantPayload()
          );
        allow update, delete: if sessionOwnedByTeacher(sessionId);
      }

      match /attempts/{attemptId} {
        allow read: if sessionOwnedByTeacher(sessionId);
        allow create: if
          sessionOwnedByTeacher(sessionId) ||
          (
            isStudent() &&
            sessionJoinable(sessionId) &&
            request.resource.data.uid == request.auth.uid &&
            cleanAttemptPayload()
          );
        allow update: if sessionOwnedByTeacher(sessionId);
        allow delete: if false;
      }
    }

    match /assignments/{assignmentId} {
      allow read: if isStudent() || (isTeacher() && assignmentOwnedByTeacher(assignmentId));
      allow create: if isTeacher() &&
        request.resource.data.quizId != null &&
        teacherOwnsQuiz(request.resource.data.quizId);
      allow update, delete: if isTeacher() && assignmentOwnedByTeacher(assignmentId);

      match /attempts/{attemptId} {
        allow create: if isStudent() &&
          request.resource.data.uid == request.auth.uid &&
          cleanAttemptPayload();
        allow read: if isTeacher() && assignmentOwnedByTeacher(assignmentId);
        allow update, delete: if false;
      }

      match /submissions/{uid} {
        allow read: if (isTeacher() && assignmentOwnedByTeacher(assignmentId)) ||
          (request.auth != null && request.auth.uid == uid);
        allow write: if false;
      }
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
